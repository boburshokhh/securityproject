#!/bin/bash
# Скрипт для безопасного обновления кода с сохранением локальных изменений

echo "=========================================="
echo "  Обновление кода с сохранением изменений"
echo "=========================================="

cd /var/www/mygov-backend

# 1. Удаляем __pycache__ файлы (они не должны быть в git)
echo ""
echo "1. Очистка __pycache__ файлов..."
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find . -name "*.pyc" -delete 2>/dev/null || true
echo "   ✓ Очистка завершена"

# 2. Проверяем статус git
echo ""
echo "2. Проверка статуса git..."
git status --short

# 3. Сохраняем локальные изменения в stash
echo ""
echo "3. Сохранение локальных изменений..."
git stash push -m "Локальные изменения перед pull $(date +%Y-%m-%d_%H:%M:%S)"

# 4. Обновляем код
echo ""
echo "4. Обновление кода из репозитория..."
git pull

if [ $? -eq 0 ]; then
    echo "   ✓ Код успешно обновлен"
else
    echo "   ✗ Ошибка при обновлении кода"
    exit 1
fi

# 5. Показываем, что было сохранено в stash
echo ""
echo "5. Сохраненные изменения (stash):"
git stash list | head -5

echo ""
echo "=========================================="
echo "  Обновление завершено!"
echo "=========================================="
echo ""
echo "Если нужно восстановить локальные изменения:"
echo "  git stash pop"
echo ""
echo "Если нужно посмотреть, что было сохранено:"
echo "  git stash show -p"
echo ""
