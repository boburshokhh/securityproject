# Исправление конвертации DOCX в PDF в my-gov-backend

## Проблема

Конвертация DOCX в PDF не работала в `my-gov-backend` из-за различий в реализации по сравнению с рабочим решением в `dmed`.

## Внесенные исправления

### 1. ✅ Добавлена поддержка Windows
- Добавлена обработка Windows с использованием `-env:UserInstallation`
- Создается отдельная временная директория для конфигурации LibreOffice на Windows
- Это решает проблемы с правами доступа и конфигурацией на Windows

### 2. ✅ Упрощены флаги LibreOffice
**Было:**
```python
cmd = [
    libreoffice_cmd,
    '--headless',
    '--nodefault',      # Удалено
    '--nolockcheck',    # Удалено
    '--nologo',         # Удалено
    '--norestore',      # Удалено
    '--invisible',      # Удалено
    '--convert-to', 'pdf',
    '--outdir', output_dir,
    abs_docx_path
]
```

**Стало:**
```python
cmd = [
    libreoffice_cmd,
    '--headless',
    '--convert-to', 'pdf',
    '--outdir', output_dir,
    abs_docx_path
]
```

Используется минимальный набор флагов для лучшей совместимости (как в dmed).

### 3. ✅ Улучшена обработка переменных окружения
- На Linux: `HOME=output_dir` (для работы с правами www-data)
- На Windows: стандартный `HOME` (конфигурация в отдельной директории)
- `TMPDIR`, `TMP`, `TEMP` всегда устанавливаются в `output_dir`

### 4. ✅ Увеличен таймаут
- Было: 120 секунд
- Стало: 180 секунд (как в dmed)
- Это позволяет обрабатывать большие документы

### 5. ✅ Улучшена обработка ошибок
Добавлена детальная обработка ошибок:
- Проверка повреждения `bootstrap.ini`
- Проверка ошибок загрузки документа
- Диагностика содержимого DOCX (проверка ZIP-архива)
- Игнорирование некритичных предупреждений (Java)

### 6. ✅ Добавлена очистка временных файлов
- Автоматическая очистка временной директории конфигурации для Windows
- Очистка выполняется как при успехе, так и при ошибке

## Сравнение: до и после

| Параметр | До исправления | После исправления | dmed |
|----------|----------------|-------------------|------|
| Поддержка Windows | ❌ | ✅ | ✅ |
| Флаги LibreOffice | 6 флагов | 3 флага | 3 флага |
| Таймаут | 120 сек | 180 сек | 180 сек |
| Обработка ошибок | Базовая | Детальная | Детальная |
| Переменные окружения | Всегда HOME=output_dir | Условно | Условно |

## Тестирование

После внесения изменений рекомендуется:

1. **Проверить на Linux:**
```bash
cd /var/www/mygov-backend
sudo systemctl restart mygov-backend
sudo journalctl -u mygov-backend -f | grep PDF_CONV
```

2. **Проверить на Windows:**
- Убедиться, что LibreOffice установлен
- Проверить логи приложения
- Протестировать генерацию документа

3. **Диагностика:**
```bash
./diagnose_pdf_conversion.sh
```

## Ожидаемые результаты

После исправлений конвертация должна работать:
- ✅ На Linux (как и раньше, но более стабильно)
- ✅ На Windows (теперь поддерживается)
- ✅ С большими документами (увеличен таймаут)
- ✅ С лучшей диагностикой ошибок

## Дополнительные улучшения

Если проблемы сохраняются, можно:
1. Добавить проверку DOCX через `python-docx` перед конвертацией (как в dmed)
2. Добавить retry-механизм при временных ошибках
3. Добавить метрики производительности конвертации
