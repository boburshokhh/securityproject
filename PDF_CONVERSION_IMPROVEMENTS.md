# Улучшения конвертации PDF

## Обзор изменений

Бэкенд теперь полностью поддерживает автоматическую конвертацию документов DOCX в PDF с улучшенной обработкой старых форматов путей.

## Основные улучшения

### 1. Автоматическая конвертация при генерации
- При создании нового документа автоматически генерируется как DOCX, так и PDF
- PDF путь автоматически сохраняется в БД

### 2. Автоматическая конвертация при скачивании
- Если PDF отсутствует, система автоматически пытается сгенерировать его из DOCX
- Автоматическое обновление старых путей DOCX в БД при необходимости

### 3. Улучшенная обработка старых форматов
- Автоматическое определение и обновление старых путей DOCX (без префикса `minio://`)
- Попытка получения файла из MinIO по нескольким вариантам:
  - По UUID документа: `minio://dmed/{uuid}.docx`
  - По имени файла из старого пути
  - По имени файла без расширения

### 4. Улучшенное логирование
- Детальное логирование всех этапов конвертации
- Логирование попыток получения файлов из MinIO
- Логирование обновлений путей в БД

## Использование

### Автоматическая конвертация
Система работает автоматически:
1. При создании документа через `/api/documents/generate`
2. При скачивании PDF через `/api/documents/{id}/download`

### Массовая конвертация старых документов
Для конвертации всех документов без PDF:

```bash
cd /var/www/mygov-backend
./fix_missing_pdf_paths.sh
```

Скрипт:
- Найдет все документы без PDF, но с DOCX
- Автоматически обновит старые пути DOCX в БД
- Конвертирует DOCX в PDF
- Обновит `pdf_path` в БД

### Диагностика конкретного документа
Для диагностики проблем с конкретным документом:

```bash
cd /var/www/mygov-backend
./diagnose_pdf_issue.sh <document_id>
```

## Технические детали

### Функция `convert_docx_to_pdf`
- Поддерживает пути MinIO (`minio://dmed/...`)
- Поддерживает локальные пути
- Автоматически обрабатывает старые форматы путей
- Использует LibreOffice для конвертации
- Сохраняет PDF в MinIO

### Функция `download_document`
- Автоматически генерирует PDF, если он отсутствует
- Обновляет старые пути DOCX в БД
- Предоставляет fallback на DOCX, если PDF не может быть создан

### Функция `generate_document`
- Создает DOCX и PDF при генерации
- Автоматически обновляет пути в БД
- Проверяет успешность обновления

## Обработка ошибок

- Если PDF не может быть создан, система предлагает скачать DOCX версию
- Все ошибки логируются с детальной информацией
- Автоматическая очистка временных файлов

## Требования

- LibreOffice установлен и доступен в системе
- MinIO настроен и доступен
- Правильные права доступа к временным директориям (`/tmp`)

## Проверка работы

После обновления кода:

```bash
# Перезапустите сервис
sudo systemctl restart mygov-backend

# Проверьте логи
sudo journalctl -u mygov-backend -f

# Протестируйте генерацию документа
curl -X POST http://localhost:8000/api/documents/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"patient_name": "Test", ...}'
```

